## What is Elasticsearch

`Elasticsearch`（简称 `es`）作为 `Elastic` 栈的核心是一款分布式搜索和分析的引擎。

`Logstacsh` 和 `Beats` 使得收集、聚合、采集数据并存储在 `es` 变得很容易。

`Kibana` 使你能够交互式地探索、可视化和分享数据的简介，并管理和监视栈。

使用案例不限于：

- app 与网页的搜索；
- 存储与分析日志、指标和安全事件数据；
- 使用机器学习来自动建模数据的实时行为；
- 使用 `es` 作为存储引擎使得业务工作流自动化；
- 使用 `es` 作为地理信息系统（GIS），管理、集成和分析空间信息；
- 使用 `es` 作为生化信息学研究工具，存储和处理基因信息；

### Data in: documents and indices

`es` 将复杂的数据结构序列化成 `JSON` 文档，而不是将信息存储为列数据行。当集群中有多个 `es` 节点时，存储的文档分布在整个集群中，可以快速地访问任意节点。

`es` 使用一种称为倒排索引（inverted index）的数据结构，支持非常快速的全文搜索。倒排索引列出了文档中每一个唯一的单词，并标识出每个单词所出现在其中的所有文档。

 索引可以看作是文档的优化集合，每个文档是字段的集合，字段是键值对的形式包含着数据。默认情况下，`es` 对每个字段中的所有数据建立索引，每个字段索引使用专门的、优化的数据结构。例如，文本字段通过倒排索引存储，数字和地理字段存储在 BKD 树中。

`es` 支持不显式指定索引方式。通过启用动态映射，`es` 会自动检测并为新字段添加索引。`es` 会检测布尔值、浮点数、整型、日期和字符串并将其映射至适当的数据类型（索引）。

但是人为定义映射有以下好处：

- 区分全文（索引）字符串字段和精确（匹配）字符串字段；
- 执行特定于语言的文本分析；
- 优化字段实现部分匹配；
- 使用自定义日期格式；
- 无法自动检测出例如 `geo_point` 和 `geo_shape` 的数据格式；

甚至可以为了不同的目的对相同的字段添加不同的索引方式；例如，索引一个字符串字段，既作为全文搜索的文本字段，又作为排序或聚合数据的关键字字段。使用多种语言的分析器来处理包含用户输入的字符串字段的内容。

在建立全文索引时所使用的分析链也会在搜索时使用。在查询全文字段时，查询的文本也需要经历同样的（索引）分析链分析后再在索引中搜索。也就是说查询的文本也需要先被分词处理等。

### Information out: search and analyze

`es` 真正的强大的功能来自于能够轻松访问构建在 Apache Lucene 搜索引擎库上的全套搜索功能。

`es` 提供了一个简单、一致的 REST API，用于管理集群、索引和搜索数据。

#### Searching your data

`es` REST API 支持结构化查询、全文查询或两者结合的复杂查询。结构化查询类似于在 SQL 中构建的查询。例如，你可以搜索员工索引中性别和年龄字段，并根据雇佣日期对匹配进行排序。全文搜索查找与查询字符串匹配的所有文档，并按相关性（与搜索内容的匹配程序）排序返回它们。

除了搜索单个词汇外，还可以执行短语搜索、相似性搜索和前缀搜索，并获得自动补全建议。

`es` 通过优化的数据结构索引非文本数据，支持高性能地理和数字查询。

这些搜索功能都可以通过 JSON 格式查询语言（Query DSL）访问。也可以构造 SQL 格式搜索和聚合数据。JDBC 和 ODBC 驱动使得大量第三方应用可以通过 SQL 与 `es` 交互。

#### Analyzing your data

聚合功能可以构建负责的数据摘要，并洞察关键指标、模式和趋势。

除了“大海捞针”搜索，聚合可以回答：

- 大海中有多少根针？
- 针的平均长度是多少？
- 针的中间长度是多少，并按照制造商区分？
- 在过去的六个月中，每个月有多少针被投入了大海中？
- 最受欢迎的制造商有哪些？
- 是不是有一些针不寻常或不正常？

因为聚合利用了用于搜索的相同数据结构，所以它们速度也非常快。

在单个请求中可以对相同的数据同时搜索文档、过滤结果和执行分析。

#### But wait, there's more

可以自动化对于时间序列数据的分析。使用机器学习创建正常行为的标准，用来识别异常模式。通过机器学习，可以检测到：

- 时间差内数值、计数或频率有关的异常；
- 统计稀有性；
- 总体中成员的异常行为；

甚至不需要指定算法、模型或其它与数据科学相关的配置就可以做到。

### Scalability and resilience

可以向集群中添加服务器（节点）来增加容量，`es` 会自动将数据和查询负载分不到所有可用的节点上。

`es` 索引只是一个或多个物理分片的逻辑分组，其中每个分片实际上是一个自包含的索引。通过将索引中的文档分布到多个分片，并将这些分片分不到多个节点，`es` 可以确保冗余，这既可以防止硬件故障，又可以在节点被添加到集群时增加查询容量。随着集群增长（或收缩），`es` 会自动迁移分片以重新平衡集群。

有两种类型的分片：主分片和副本分片。每个索引中的文档属于某个主分片。一个副本分片是一个主分片的拷贝。副本分片提供数据的冗余拷贝，以防止硬件故障，并增加处理读取请求，如搜索或检索文档的能力。

当索引建立时，主分片的数量就被固定下来了；但是副本分片的数量可以随意修改，不需要中断索引或查询操作。

#### It depends...

对于为索引配置的分片大小和主分片的数量，有许多性能上的考虑和权衡。分片越多，维护这些索引的开销就越大。当 `es` 需要重新平衡集群时，分片的大小越大，移动碎片所需要的时间就越长。

查询大量的小分片会使每个分片的处理速度更快，但是更多查询意味着开销越大，所以查询少量的大分片可能会更快。

作为起点：

- 考虑将平均分片大小保持在几 GB 到 几十 GB 之间。对于基于时间的数据，一般会看到 20GB 到 40GB 的分片；
- 避免大量分片。一个节点可以保存的分片数量与可用堆空间成正比。一般来说，每 GB 堆空间的分片数量应小于 20；

#### In case of disaster

为了保持高可用性，需要避免任何单点故障。在一个位置发生重大中断的情况下，另一个位置的服务器需要能够接管。那就是跨集群复制（Cross-cluster replication，CCR）。

CCR 提供了一种将索引从主集群自动同步到远程的从集群，后者可以作为热备份。如果主集群发生故障，从集群可以接管服务。甚至可以使用 CCR 创建从集群，为地理位置靠近的用户提供读请求服务。

CCR 采用主备模式。在主集群上的索引管理着索引，处理处理所有的写请求。复制到从集群的索引只能提供备份的只读服务。

#### Care and feeding

Kibana 作为管理集群的控制中心，可以保护、管理和监控 `es` 集群。
